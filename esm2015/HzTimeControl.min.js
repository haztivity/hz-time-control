/**
 * @license @haztivity/hz-time-control v0.7.0
 * (c) 2018 Finsi, Inc.
 */

function __decorate(t,e,i,n){var o,r=arguments.length,a=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a}import{$,Navigator,Component,ComponentController,EventEmitterFactory,PageManager,PageController,DataOptions,ScoFactory,DevTools,ScormService,ScoController,Service}from"@haztivity/core";let HzTimeControlComponent=HzTimeControlComponent_1=class t extends ComponentController{constructor(t,e,i,n,o,r,a){if(super(t,e),this._Navigator=i,this._PageManager=n,this._DataOptions=o,this._ScormService=r,this._DevTools=a,this._currentSco=ScoFactory.getCurrentSco(),this._times=new Map,HzTimeControlComponent_1.__instance)throw"[HzTimeControlComponent] There must be only one component of HzTimeControl";HzTimeControlComponent_1.__instance=this}init(t,e){if(this._options=$.extend(!0,{},HzTimeControlComponent_1._DEFAULTS,t),void 0==this._options.time)throw"[HzTimeControlComponent] The option 'time' is mandatory";this._options.time=Math.round(this._options.time),this._totalTimeInMillis=6e4*this._options.time;let i=[];if(this._ScormService.LMSIsInitialized()){const t=this._ScormService.doLMSGetValue("cmi.suspend_data");if(t)try{i=JSON.parse(t).tc||[]}catch(t){i=[]}}if(this._state=i,this._options.times)for(let t in this._options.times){let e=this._options.times[t];e.weight=void 0!=e.weight?Math.round(e.weight):1,e.completed=-1!=i.indexOf(t),this._times.set(t,e)}const n=this._PageManager.getPages();for(let t of n){const e=t.getPage().getOptions().timeControl;if(e){const n=t.getPageName();e.weight=void 0!=e.weight?Math.round(e.weight):1,e.completed=-1!=i.indexOf(n),this._times.set(n,e)}}this._assignEvents()}_assignEvents(){this._eventEmitter.globalEmitter.on(ScoController.ON_BEFORE_EXIT,{instance:this},this._onScoExit),this._Navigator.on(Navigator.ON_CHANGE_PAGE_START,{instance:this},this._onPageChangeStart),this._Navigator.on(Navigator.ON_CHANGE_PAGE_END,{instance:this},this._onPageChangeEnd),this._Navigator.on(Navigator.ON_NEXT_ENABLE,{instance:this},this._onNavigatorEnabled)}_onScoExit(t){t.data.instance._completeCurrentProcess(!0)}_getOptionsForPage(t){return this._times.get(t)}_getCurrentWeight(){let t=this._PageManager.getPages(),e=0;for(let i of t){const t=this._getOptionsForPage(i.getPageName());t.completed||(e+=t.weight)}return e}_onNavigatorEnabled(t){let e=t.data.instance;e._waiting&&e._Navigator.setNextDisabled(!0)}_endWaiting(){this._waiting=!1,this._currentWaitTimeout&&(clearTimeout(this._currentWaitTimeout),this._currentWaitTimeout=null),this._debugWaitingTimeInterval&&(clearInterval(this._debugWaitingTimeInterval),this._debugWaitingTimeInterval=null),this._startWaitingDate=null,this._currentTimeToWait=null}_startWaiting(){if(!this._waiting){this._waiting=!0,this._Navigator.setNextDisabled(!0);let t=(this._dateCurrentPageEnd?this._dateCurrentPageEnd.getTime():(new Date).getTime())-this._dateCurrentPageStart.getTime(),e=Math.round(this._currentPageRequiredTime-t);this._currentTimeToWait=e>=2e3?e:2e3,this._startWaitingDate=new Date;let i=this;if(this._currentWaitTimeout=setTimeout(function(){i._onWaitingTimeComplete()},this._currentTimeToWait),this._DevTools.isEnabled()){const e=Math.round(this._currentTimeToWait/1e3);console.debug("[HzTimeControlComponent] Start waiting. Data:",{timeInPage:t/1e3+" seconds",timeToWait:e}),this._initLogger(e,e)}this._eventEmitter.trigger(HzTimeControlComponent_1.ON_WAITING_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._eventEmitter.globalEmitter.trigger(HzTimeControlComponent_1.ON_WAITING_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait])}}_initLogger(t,e){this._debugWaitingTimeInterval&&clearInterval(this._debugWaitingTimeInterval);let i=0,n=this;const o=t>300?6e4:t>120?3e4:t>30?1e4:1e3;console.debug("[HzTimeControl]",`Waiting ${e} seconds, pending ${t}. ${o>1e3?"Next log in "+o/1e3+"seconds":""}`),this._debugWaitingTimeInterval=setInterval(function(){const r=t-(i+=o/1e3);r<300&&r>120&&o>3e4||r<120&&r>30&&o>1e4||r<30&&o>1e3?n._initLogger(r,e):console.debug("[HzTimeControl]",`Waiting ${e} seconds, pending ${r}. ${o>1e3?"Next log in "+o/1e3+"seconds":""}`)},o)}_onWaitingTimeComplete(){this._endWaiting();const t=this._currentPage.getPageName();let e=this._times.get(t);e.completed=!0,this._times.set(t,e),this._Navigator.setNextDisabled(!1),this._DevTools.isEnabled()&&console.debug(`[HzTimeControlComponent] Process completed. Navigation enabled.`),-1==this._state.indexOf(t)&&this._state.push(t);let i=this._ScormService.getSuspendData();i.tc=this._state,this._ScormService.setSuspendData(i);const n=this._currentTimeToWait;this._eventEmitter.trigger(HzTimeControlComponent_1.ON_WAITING_COMPLETE,[t,n]),this._eventEmitter.globalEmitter.trigger(HzTimeControlComponent_1.ON_WAITING_COMPLETE,[t,n])}_startProcess(t){this._completeCurrentProcess(this._waiting),this._currentPage=t;const e=t.getPageName(),i=this._getOptionsForPage(e);if(i.weight>0&&!i.completed){this._eventEmitter.trigger(HzTimeControlComponent_1.ON_PROCESS_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._eventEmitter.globalEmitter.trigger(HzTimeControlComponent_1.ON_PROCESS_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._dateCurrentPageStart=new Date;const e=this._getCurrentWeight(),n=Math.round((this._totalTimeInMillis-this._currentSco.getTotalTime(!0))/e);this._currentPageRequiredTime=Math.round(n*i.weight),this._DevTools.isEnabled()&&console.debug(`[HzTimeControlComponent] Starting process. Data:`,{totalWeight:this._getCurrentWeight(),totalTimeRequired:this._options.time+" minute/s",totalTimeSpend:this._currentSco.getTotalTimeFormatted(!0),currentPage:t.getPageName(),pageWeight:e,timeForEachWeight:n/1e3+" seconds",timeRequiredForPage:this._currentPageRequiredTime/1e3+" seconds"}),t.getPage().off("."+HzTimeControlComponent_1.NAMESPACE).on(`${PageController.ON_COMPLETE_CHANGE}.${HzTimeControlComponent_1.NAMESPACE}`,{instance:this},this._onPageCompleteChange)}}_completeCurrentProcess(t=!1){this._endWaiting(),this._currentTimeToWait=null,this._currentPage&&this._currentPage.getPage().off("."+HzTimeControlComponent_1.NAMESPACE),this._DevTools.isEnabled()&&t&&console.debug(`[HzTimeControlComponent] Process cancelled`);const e=this._currentPage?this._currentPage.getPageName():"";this._currentPageRequiredTime=null,this._dateCurrentPageStart=null,this._dateCurrentPageEnd=null,this._eventEmitter.trigger(HzTimeControlComponent_1.ON_PROCESS_COMPLETE,[e,t]),this._eventEmitter.globalEmitter.trigger(HzTimeControlComponent_1.ON_PROCESS_COMPLETE,[e,t])}_onPageChangeStart(t,e,i){let n=t.data.instance;n._pageChangeCompleted=!1;let o=n._PageManager.getPage(e.index);n._startProcess(o)}_onPageChangeEnd(t,e,i){let n=t.data.instance;n._pageChangeCompleted=!0;let o=n._Navigator.getCurrentPage(),r=o.getPage(),a=n._getOptionsForPage(r.getName());o.isCompleted()&&n._currentPageRequiredTime&&!a.completed&&n._startWaiting()}_onPageCompleteChange(t,e){if(e){let e=t.data.instance;e._dateCurrentPageEnd=new Date;let i=e._Navigator.getCurrentPage(),n=e._times.get(i.getPageName());e._pageChangeCompleted&&n.weight>0&&!n.completed&&e._startWaiting()}}isWaiting(){return this._waiting}timeToWait(){return this._currentTimeToWait}requiredTimeForPage(){return this._currentPageRequiredTime}getTimeWaitedAsMillis(){if(this._startWaitingDate){let t=new Date;return t.getTime()-this._startWaitingDate.getTime()}return 0}};HzTimeControlComponent.NAMESPACE="hzTimeControl",HzTimeControlComponent.PREFIX="hz-time-control",HzTimeControlComponent.ON_PROCESS_STARTS=`${HzTimeControlComponent_1.NAMESPACE}:process-start`,HzTimeControlComponent.ON_PROCESS_COMPLETE=`${HzTimeControlComponent_1.NAMESPACE}:process-complete`,HzTimeControlComponent.ON_WAITING_STARTS=`${HzTimeControlComponent_1.NAMESPACE}:waitingstarts`,HzTimeControlComponent.ON_WAITING_COMPLETE=`${HzTimeControlComponent_1.NAMESPACE}:waitingcomplete`,HzTimeControlComponent._DEFAULTS={scale:!1},HzTimeControlComponent=HzTimeControlComponent_1=__decorate([Component({name:"HzTimeControl",dependencies:[$,EventEmitterFactory,Navigator,PageManager,DataOptions,ScormService,DevTools]})],HzTimeControlComponent);var HzTimeControlComponent_1;let HzTimeControlService=class t{constructor(){let t=["isWaiting","timeToWait","requiredTimeForPage","getTimeWaitedAsMillis","on","one","off"];for(let e of t)this[e]=HzTimeControlComponent.__instance[e].bind(HzTimeControlComponent.__instance)}isWaiting(){}timeToWait(){}requiredTimeForPage(){}getTimeWaitedAsMillis(){}on(t,e,i){}one(t,e,i){}off(t,e){}};HzTimeControlService.ON_PROCESS_COMPLETE=HzTimeControlComponent.ON_PROCESS_COMPLETE,HzTimeControlService.ON_PROCESS_STARTS=HzTimeControlComponent.ON_PROCESS_STARTS,HzTimeControlService.ON_WAITING_COMPLETE=HzTimeControlComponent.ON_WAITING_COMPLETE,HzTimeControlService.ON_WAITING_STARTS=HzTimeControlComponent.ON_WAITING_STARTS,HzTimeControlService=__decorate([Service({name:"HzTimeControlService",dependencies:[]})],HzTimeControlService);export{HzTimeControlComponent,HzTimeControlService};
