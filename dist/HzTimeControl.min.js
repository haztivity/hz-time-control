/**
 * @license @haztivity/hz-time-control v0.7.0
 * (c) 2018 Finsi, Inc.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@haztivity/core")):"function"==typeof define&&define.amd?define(["exports","@haztivity/core"],e):e(t.HzTimeControl={},null)}(this,function(t,e){"use strict";function i(t,e,i,n){var o,r=arguments.length,a=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a}var n=function(t){function n(i,n,r,a,s,g,_){var c=t.call(this,i,n)||this;if(c._Navigator=r,c._PageManager=a,c._DataOptions=s,c._ScormService=g,c._DevTools=_,c._currentSco=e.ScoFactory.getCurrentSco(),c._times=new Map,o.__instance)throw"[HzTimeControlComponent] There must be only one component of HzTimeControl";return o.__instance=c,c}return function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);function n(){this.constructor=t}t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(n,t),o=n,n.prototype.init=function(t,i){if(this._options=e.$.extend(!0,{},o._DEFAULTS,t),void 0==this._options.time)throw"[HzTimeControlComponent] The option 'time' is mandatory";this._options.time=Math.round(this._options.time),this._totalTimeInMillis=6e4*this._options.time;var n=[];if(this._ScormService.LMSIsInitialized()){var r=this._ScormService.doLMSGetValue("cmi.suspend_data");if(r)try{n=JSON.parse(r).tc||[]}catch(t){n=[]}}if(this._state=n,this._options.times)for(var a in this._options.times){var s=this._options.times[a];s.weight=void 0!=s.weight?Math.round(s.weight):1,s.completed=-1!=n.indexOf(a),this._times.set(a,s)}for(var g=0,_=this._PageManager.getPages();g<_.length;g++){var c=_[g],h=c.getPage().getOptions().timeControl;if(h){var m=c.getPageName();h.weight=void 0!=h.weight?Math.round(h.weight):1,h.completed=-1!=n.indexOf(m),this._times.set(m,h)}}this._assignEvents()},n.prototype._assignEvents=function(){this._eventEmitter.globalEmitter.on(e.ScoController.ON_BEFORE_EXIT,{instance:this},this._onScoExit),this._Navigator.on(e.Navigator.ON_CHANGE_PAGE_START,{instance:this},this._onPageChangeStart),this._Navigator.on(e.Navigator.ON_CHANGE_PAGE_END,{instance:this},this._onPageChangeEnd),this._Navigator.on(e.Navigator.ON_NEXT_ENABLE,{instance:this},this._onNavigatorEnabled)},n.prototype._onScoExit=function(t){t.data.instance._completeCurrentProcess(!0)},n.prototype._getOptionsForPage=function(t){return this._times.get(t)},n.prototype._getCurrentWeight=function(){for(var t=0,e=0,i=this._PageManager.getPages();e<i.length;e++){var n=i[e],o=this._getOptionsForPage(n.getPageName());o.completed||(t+=o.weight)}return t},n.prototype._onNavigatorEnabled=function(t){var e=t.data.instance;e._waiting&&e._Navigator.setNextDisabled(!0)},n.prototype._endWaiting=function(){this._waiting=!1,this._currentWaitTimeout&&(clearTimeout(this._currentWaitTimeout),this._currentWaitTimeout=null),this._debugWaitingTimeInterval&&(clearInterval(this._debugWaitingTimeInterval),this._debugWaitingTimeInterval=null),this._startWaitingDate=null,this._currentTimeToWait=null},n.prototype._startWaiting=function(){if(!this._waiting){this._waiting=!0,this._Navigator.setNextDisabled(!0);var t=(this._dateCurrentPageEnd?this._dateCurrentPageEnd.getTime():(new Date).getTime())-this._dateCurrentPageStart.getTime(),e=Math.round(this._currentPageRequiredTime-t);this._currentTimeToWait=e>=2e3?e:2e3,this._startWaitingDate=new Date;var i=this;if(this._currentWaitTimeout=setTimeout(function(){i._onWaitingTimeComplete()},this._currentTimeToWait),this._DevTools.isEnabled()){var n=Math.round(this._currentTimeToWait/1e3);console.debug("[HzTimeControlComponent] Start waiting. Data:",{timeInPage:t/1e3+" seconds",timeToWait:n}),this._initLogger(n,n)}this._eventEmitter.trigger(o.ON_WAITING_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._eventEmitter.globalEmitter.trigger(o.ON_WAITING_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait])}},n.prototype._initLogger=function(t,e){this._debugWaitingTimeInterval&&clearInterval(this._debugWaitingTimeInterval);var i=0,n=this,o=t>300?6e4:t>120?3e4:t>30?1e4:1e3;console.debug("[HzTimeControl]","Waiting "+e+" seconds, pending "+t+". "+(o>1e3?"Next log in "+o/1e3+"seconds":"")),this._debugWaitingTimeInterval=setInterval(function(){var r=t-(i+=o/1e3);r<300&&r>120&&o>3e4||r<120&&r>30&&o>1e4||r<30&&o>1e3?n._initLogger(r,e):console.debug("[HzTimeControl]","Waiting "+e+" seconds, pending "+r+". "+(o>1e3?"Next log in "+o/1e3+"seconds":""))},o)},n.prototype._onWaitingTimeComplete=function(){this._endWaiting();var t=this._currentPage.getPageName(),e=this._times.get(t);e.completed=!0,this._times.set(t,e),this._Navigator.setNextDisabled(!1),this._DevTools.isEnabled()&&console.debug("[HzTimeControlComponent] Process completed. Navigation enabled."),-1==this._state.indexOf(t)&&this._state.push(t);var i=this._ScormService.getSuspendData();i.tc=this._state,this._ScormService.setSuspendData(i);var n=this._currentTimeToWait;this._eventEmitter.trigger(o.ON_WAITING_COMPLETE,[t,n]),this._eventEmitter.globalEmitter.trigger(o.ON_WAITING_COMPLETE,[t,n])},n.prototype._startProcess=function(t){this._completeCurrentProcess(this._waiting),this._currentPage=t;var i=t.getPageName(),n=this._getOptionsForPage(i);if(n.weight>0&&!n.completed){this._eventEmitter.trigger(o.ON_PROCESS_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._eventEmitter.globalEmitter.trigger(o.ON_PROCESS_STARTS,[this._currentPage.getPageName(),this._currentTimeToWait]),this._dateCurrentPageStart=new Date;var r=this._getCurrentWeight(),a=Math.round((this._totalTimeInMillis-this._currentSco.getTotalTime(!0))/r);this._currentPageRequiredTime=Math.round(a*n.weight),this._DevTools.isEnabled()&&console.debug("[HzTimeControlComponent] Starting process. Data:",{totalWeight:this._getCurrentWeight(),totalTimeRequired:this._options.time+" minute/s",totalTimeSpend:this._currentSco.getTotalTimeFormatted(!0),currentPage:t.getPageName(),pageWeight:r,timeForEachWeight:a/1e3+" seconds",timeRequiredForPage:this._currentPageRequiredTime/1e3+" seconds"}),t.getPage().off("."+o.NAMESPACE).on(e.PageController.ON_COMPLETE_CHANGE+"."+o.NAMESPACE,{instance:this},this._onPageCompleteChange)}},n.prototype._completeCurrentProcess=function(t){void 0===t&&(t=!1),this._endWaiting(),this._currentTimeToWait=null,this._currentPage&&this._currentPage.getPage().off("."+o.NAMESPACE),this._DevTools.isEnabled()&&t&&console.debug("[HzTimeControlComponent] Process cancelled");var e=this._currentPage?this._currentPage.getPageName():"";this._currentPageRequiredTime=null,this._dateCurrentPageStart=null,this._dateCurrentPageEnd=null,this._eventEmitter.trigger(o.ON_PROCESS_COMPLETE,[e,t]),this._eventEmitter.globalEmitter.trigger(o.ON_PROCESS_COMPLETE,[e,t])},n.prototype._onPageChangeStart=function(t,e,i){var n=t.data.instance;n._pageChangeCompleted=!1;var o=n._PageManager.getPage(e.index);n._startProcess(o)},n.prototype._onPageChangeEnd=function(t,e,i){var n=t.data.instance;n._pageChangeCompleted=!0;var o=n._Navigator.getCurrentPage(),r=o.getPage(),a=n._getOptionsForPage(r.getName());o.isCompleted()&&n._currentPageRequiredTime&&!a.completed&&n._startWaiting()},n.prototype._onPageCompleteChange=function(t,e){if(e){var i=t.data.instance;i._dateCurrentPageEnd=new Date;var n=i._Navigator.getCurrentPage(),o=i._times.get(n.getPageName());i._pageChangeCompleted&&o.weight>0&&!o.completed&&i._startWaiting()}},n.prototype.isWaiting=function(){return this._waiting},n.prototype.timeToWait=function(){return this._currentTimeToWait},n.prototype.requiredTimeForPage=function(){return this._currentPageRequiredTime},n.prototype.getTimeWaitedAsMillis=function(){return this._startWaitingDate?(new Date).getTime()-this._startWaitingDate.getTime():0},n.NAMESPACE="hzTimeControl",n.PREFIX="hz-time-control",n.ON_PROCESS_STARTS=o.NAMESPACE+":process-start",n.ON_PROCESS_COMPLETE=o.NAMESPACE+":process-complete",n.ON_WAITING_STARTS=o.NAMESPACE+":waitingstarts",n.ON_WAITING_COMPLETE=o.NAMESPACE+":waitingcomplete",n._DEFAULTS={scale:!1},n=o=i([e.Component({name:"HzTimeControl",dependencies:[e.$,e.EventEmitterFactory,e.Navigator,e.PageManager,e.DataOptions,e.ScormService,e.DevTools]})],n);var o}(e.ComponentController),o=function(){function t(){for(var t=0,e=["isWaiting","timeToWait","requiredTimeForPage","getTimeWaitedAsMillis","on","one","off"];t<e.length;t++){var i=e[t];this[i]=n.__instance[i].bind(n.__instance)}}return t.prototype.isWaiting=function(){},t.prototype.timeToWait=function(){},t.prototype.requiredTimeForPage=function(){},t.prototype.getTimeWaitedAsMillis=function(){},t.prototype.on=function(t,e,i){},t.prototype.one=function(t,e,i){},t.prototype.off=function(t,e){},t.ON_PROCESS_COMPLETE=n.ON_PROCESS_COMPLETE,t.ON_PROCESS_STARTS=n.ON_PROCESS_STARTS,t.ON_WAITING_COMPLETE=n.ON_WAITING_COMPLETE,t.ON_WAITING_STARTS=n.ON_WAITING_STARTS,t=i([e.Service({name:"HzTimeControlService",dependencies:[]})],t)}();t.HzTimeControlComponent=n,t.HzTimeControlService=o,Object.defineProperty(t,"__esModule",{value:!0})});
